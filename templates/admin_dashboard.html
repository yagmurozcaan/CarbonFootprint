<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Şişe Takip ve Rapor Paneli</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: 'Inter', sans-serif; background-color: #E3F2FD; color: #0D47A1; padding: 20px; }
  header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
  header img { max-height: 60px; }
  h1 { font-weight: 700; font-size: 2rem; margin:0; }
  .btn-logout { background: #ff4d4f; color:white; font-weight:600; padding:10px 20px; border-radius:6px; text-decoration:none; }
  .insight-cards { display:flex; flex-wrap:wrap; gap:20px; margin-bottom:30px; }
  .card-insight { background:#BBDEFB; flex:1 1 200px; padding:20px; border-radius:16px; text-align:center; transition: transform 0.3s; }
  .card-insight:hover { transform: translateY(-5px); }
  .card-insight h3 { font-size:1.3rem; margin-bottom:10px; }
  .card-insight p { font-size:1.1rem; font-weight:600; }
  table { width:100%; border-collapse:collapse; border-radius:12px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,0.1); background:white; }
  thead { background:#2196F3; color:white; font-weight:600; }
  th, td { padding:12px; text-align:center; border-bottom:1px solid #e1e4e8; }
  tbody tr:hover { background:#e3f2fd; }
  #chartsContainer { display:flex; gap:30px; flex-wrap:wrap; margin-top:30px; }
  canvas { background:white; border-radius:16px; width:100%; max-width:400px !important; height:auto !important; }
</style>
</head>
<body>

<header class="d-flex align-items-center justify-content-between mb-4">
  <div class="d-flex align-items-center gap-3">
    <img src="/static/revego.png" alt="Logo" style="height:50px;">
    <h1 class="m-0">Şişe Takip Paneli</h1>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('admin_bp.dashboard_home') }}" class="btn btn-primary">Anasayfa</a>
    <a href="{{ url_for('admin_bp.admin_logout') }}" class="btn btn-danger">Çıkış Yap</a>
  </div>
</header>




<div class="insight-cards">
  <div class="card-insight"><h3>Toplam Şişe</h3><p id="totalBottles">0</p></div>
  <div class="card-insight"><h3>Toplam Karbon</h3><p id="totalCarbon">0 kg CO₂</p></div>
  <div class="card-insight"><h3>Günlük Şişe</h3><p id="dailyBottles">0</p></div>
  <div class="card-insight"><h3>Haftalık Şişe</h3><p id="weeklyBottles">0</p></div>
</div>

<div class="mb-3">
  <form id="reportForm" class="d-flex gap-2">
    <select id="reportYear" class="form-select w-auto">
      {% for y in years %}<option value="{{ y }}">{{ y }}</option>{% endfor %}
    </select>
    <select id="reportMonth" class="form-select w-auto">
      {% for m in range(1,13) %}<option value="{{ m }}">{{ m }}</option>{% endfor %}
    </select>
    <button type="button" class="btn btn-primary" onclick="downloadReport()">Aylık Rapor İndir</button>
  </form>
</div>

<div>
  <table>
    <thead>
      <tr>
        <th>Şişe Türü</th>
        <th>Adet</th>
        <th>Karbon Ayak İzi (kg CO₂)</th>
        <th>Tarih</th>
      </tr>
    </thead>
    <tbody id="allBottlesTableBody"></tbody>
  </table>
</div>

<div id="chartsContainer">
  <canvas id="bottleChart" role="img" aria-label="Şişe Türlerine Göre Dağılım"></canvas>
  <canvas id="carbonChart" role="img" aria-label="Şişe Türlerine Göre Karbon Ayak İzi"></canvas>
</div>

<div class="mt-4">
  <form id="bottleForm" class="d-flex gap-2">
    <select id="bottleType">
      <option value="cam">Cam</option>
      <option value="alüminyum">Alüminyum</option>
      <option value="plastik">Plastik</option>
    </select>
    <input type="number" id="quantity" min="1" value="1">
    <button type="submit" class="btn btn-success">Ekle</button>
  </form>
  <p id="status" class="mt-2"></p>
</div>

<script>
const API_KEY = "admin123"; // x-api-key header
let bottleChart = null;
let carbonChart = null;

async function loadAllBottles(){
  const res = await fetch("/api/all_bottles", { headers:{ "x-api-key": API_KEY } });
  if(!res.ok) return;
  const data = await res.json();

  // Tablo
  const tbody = document.getElementById("allBottlesTableBody");
  tbody.innerHTML = "";
  let totalBottles=0, totalCarbon=0, dailyBottles=0, weeklyBottles=0;
  const today = new Date().toISOString().slice(0,10);
  const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);

  data.forEach(b=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${b.bottle_type}</td><td>${b.quantity}</td><td>${b.carbon_footprint.toFixed(2)}</td><td>${new Date(b.created_at).toLocaleString()}</td>`;
    tbody.appendChild(tr);

    totalBottles += b.quantity;
    totalCarbon += b.carbon_footprint;
    const created = new Date(b.created_at);
    if(created.toISOString().slice(0,10) === today) dailyBottles+=b.quantity;
    if(created>=weekAgo) weeklyBottles+=b.quantity;
  });

  // Kartlar
  document.getElementById("totalBottles").textContent = totalBottles;
  document.getElementById("totalCarbon").textContent = totalCarbon.toFixed(2) + " kg CO₂";
  document.getElementById("dailyBottles").textContent = dailyBottles;
  document.getElementById("weeklyBottles").textContent = weeklyBottles;

  // Grafikler
  const typeCount = {};
  const carbonCount = {};
  data.forEach(b => {
    typeCount[b.bottle_type] = (typeCount[b.bottle_type]||0)+b.quantity;
    carbonCount[b.bottle_type] = (carbonCount[b.bottle_type]||0)+b.carbon_footprint;
  });

  const labels = Object.keys(typeCount);
  const quantities = Object.values(typeCount);
  const carbonData = Object.values(carbonCount);

  const ctx1 = document.getElementById("bottleChart").getContext("2d");
  if(bottleChart) bottleChart.destroy();
  bottleChart = new Chart(ctx1,{type:'doughnut', data:{labels,datasets:[{label:'Şişe Adedi',data:quantities, backgroundColor:['#42a5f5','#ffb74d','#66bb6a']}]}, options:{responsive:true, plugins:{legend:{position:'bottom'}}}});

  const ctx2 = document.getElementById("carbonChart").getContext("2d");
  if(carbonChart) carbonChart.destroy();
  carbonChart = new Chart(ctx2,{type:'doughnut', data:{labels,datasets:[{label:'Karbon Ayak İzi',data:carbonData, backgroundColor:['#42a5f5','#ffb74d','#66bb6a']}]}, options:{responsive:true, plugins:{legend:{position:'bottom'}}}});
}

document.getElementById("bottleForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const type = document.getElementById("bottleType").value;
  const qty = parseInt(document.getElementById("quantity").value);
  const res = await fetch("/api/add_bottle",{method:'POST',headers:{'Content-Type':'application/json','x-api-key':API_KEY},body:JSON.stringify({bottle_type:type,quantity:qty})});
  const statusEl = document.getElementById("status");
  if(res.ok){ statusEl.textContent="Başarıyla eklendi!"; statusEl.style.color='blue'; await loadAllBottles(); }
  else{ statusEl.textContent="Hata oluştu!"; statusEl.style.color='red'; }
});

function downloadReport(){
  const year = document.getElementById("reportYear").value;
  const month = document.getElementById("reportMonth").value;
  if(!year || !month){ alert("Lütfen yıl ve ay seçiniz!"); return; }
  window.open(`/admin/download_monthly_report?year=${year}&month=${month}`,'_blank');
}

loadAllBottles();
setInterval(loadAllBottles,10000);
</script>
</body>
</html>
